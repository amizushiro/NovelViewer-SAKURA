/**
NovelViewer SAKURA

Copyright (c)2020 Aya Mizushiro

This software is released under the MIT License.
http://opensource.org/licenses/mit-license.php
*/
class SNViwerAppClass{constructor(e){this.indent=!!(e&&"indent"in e)&&e.indent,this.convert=!(e&&"convert"in e)||e.convert,this.return=!!(e&&"return"in e)&&e.return,this.twitter=!!(e&&"twitter"in e)&&e.twitter,this.indexList=!!(e&&"indexList"in e)&&e.indexList,this.touchDevice=this.isTouchDevice(),this.imageUrls="",this.imageLoading=!1,this.wrapper=document.getElementById("app"),this.init()}init(){if(this.insertLoading(),this.fontCheck()&&this.insertFont(),this.createMenu(this.indexList),this.convert&&(this.imageLoading=this.convertNovelText()),null!=document.getElementById("nvl-title")&&document.getElementById("nvl-title").classList.add("novel-title"),null!=document.getElementById("nvl-subtitle")&&document.getElementById("nvl-subtitle").classList.add("novel-subtitle"),null!=document.getElementById("nvl-section-title")){const e=document.getElementById("nvl-section-title");e.classList.add("section-title");const t=this.createSpanEl("","",e.textContent.trim());e.textContent="",e.appendChild(t)}null!=document.getElementById("novel-body")&&document.getElementById("novel-body").classList.add("novel-block"),this.saveStyleLoad(),this.imageLoading||("rtl"===this.writing&&this.setScrollX(),this.loadingHide())}insertLoading(){const e=this.createDivEl("loading","loader-wrapper"),t=this.createDivEl("","loading");t.appendChild(this.createSpanEl("","","Loading...")),e.appendChild(t),document.body.appendChild(e)}insertFont(){const e=document.createElement("link");e.rel="stylesheet",e.href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap",document.getElementsByTagName("head")[0].appendChild(e),e.href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP&display=swap",document.getElementsByTagName("head")[0].appendChild(e)}createMenu(e){const t=this.createMenuEl("","");this.return&&t.appendChild(this.createAEl("","novel-close-button",this.return,"×閉じる"));const i=this.createLabelEl("close-style","menu-close-toggle","novel-style-toggle","close");i.style.display="none",t.appendChild(i);const n=this.createLabelEl("close-index","menu-close-toggle","novel-index-toggle","close");n.style.display="none",t.appendChild(n),t.appendChild(this.createStyleMenu()),0<Object.keys(e).length&&t.appendChild(this.createIndex(e)),this.wrapper.appendChild(t)}createStyleMenu(){const e=this.createDivEl("",""),t=this.craeteCheckboxEl("novel-style-toggle","");t.addEventListener("change",e=>{this.toggleStyle(e)},!1),e.appendChild(t),e.appendChild(this.createLabelEl("","novel-style-toggle-label","novel-style-toggle","スタイル"));const i=this.createDivEl("novel-style-menu","novel-menu"),n=this.createDivEl("","novel-style-contents"),l=this.createDivEl("","menu-item-wrap");l.appendChild(this.createPEl("","menu-item-label","文字サイズ"));const s=this.createDivEl("","novel-radio-wrap"),a=this.createRadioEl("fontsize-small","","fontsize");a.addEventListener("change",e=>{this.toggleFontsize(e)},!1),s.appendChild(a),s.appendChild(this.createLabelEl("",["radio-label-style","style-small"],"fontsize-small","小"));const d=this.createRadioEl("fontsize-normal","","fontsize","normal");d.addEventListener("change",e=>{this.toggleFontsize(e)},!1),s.appendChild(d),s.appendChild(this.createLabelEl("",["radio-label-style","style-normal"],"fontsize-normal","中"));const o=this.createRadioEl("fontsize-large","","fontsize","large");o.addEventListener("change",e=>{this.toggleFontsize(e)},!1),s.appendChild(o),s.appendChild(this.createLabelEl("",["radio-label-style","style-large"],"fontsize-large","大"));const r=this.createRadioEl("fontsize-oversize","","fontsize","oversize");r.addEventListener("change",e=>{this.toggleFontsize(e)},!1),s.appendChild(r),s.appendChild(this.createLabelEl("",["radio-label-style","style-oversize"],"fontsize-oversize","特大")),l.appendChild(s),n.appendChild(l);const h=this.createDivEl("","menu-item-wrap");h.appendChild(this.createPEl("","menu-item-label","背景"));const c=this.createDivEl("","novel-radio-wrap"),p=this.createRadioEl("theme-white","","theme","white");p.addEventListener("change",e=>{this.toggleTheme(e)},!1),c.appendChild(p),c.appendChild(this.createLabelEl("",["radio-label-style","style-white"],"theme-white","白"));const g=this.createRadioEl("theme-dark","","theme","dark");g.addEventListener("change",e=>{this.toggleTheme(e)},!1),c.appendChild(g),c.appendChild(this.createLabelEl("",["radio-label-style","style-dark"],"theme-dark","黒"));const m=this.createRadioEl("theme-kinari","","theme","kinari");m.addEventListener("change",e=>{this.toggleTheme(e)},!1),c.appendChild(m),c.appendChild(this.createLabelEl("",["radio-label-style","style-kinari"],"theme-kinari","生成り")),h.appendChild(c),n.appendChild(h);const u=this.createDivEl("","menu-item-wrap");u.appendChild(this.createPEl("","menu-item-label","フォント"));const E=this.createDivEl("","novel-radio-wrap"),C=this.createRadioEl("font-mincho","","font","mincho");C.addEventListener("change",e=>{this.toggleFont(e)},!1),E.appendChild(C),E.appendChild(this.createLabelEl("",["radio-label-style","style-mincho"],"font-mincho","明朝"));const v=this.createRadioEl("font-gothic","","font","gothic");v.addEventListener("change",e=>{this.toggleFont(e)},!1),E.appendChild(v),E.appendChild(this.createLabelEl("",["radio-label-style","style-gothic"],"font-gothic","ゴシック")),u.appendChild(E),n.appendChild(u);const y=this.createDivEl("","menu-item-wrap");y.appendChild(this.createPEl("","menu-item-label","組版"));const b=this.createDivEl("","novel-radio-wrap"),w=this.createRadioEl("write-rtl","","write","rtl");w.addEventListener("change",e=>{this.toggleWriting(e)},!1),b.appendChild(w),b.appendChild(this.createLabelEl("",["radio-label-style","style-rtl"],"write-rtl","縦書き"));const f=this.createRadioEl("write-ltr","","write","ltr");return f.addEventListener("change",e=>{this.toggleWriting(e)},!1),b.appendChild(f),b.appendChild(this.createLabelEl("",["radio-label-style","style-ltr"],"write-ltr","横書き")),y.appendChild(b),n.appendChild(y),i.appendChild(n),e.appendChild(i),e}createIndex(e){const t=this.createDivEl("",""),i=this.craeteCheckboxEl("novel-index-toggle","");i.addEventListener("change",e=>{this.toggleIndex(e)},!1),t.appendChild(i),t.appendChild(this.createLabelEl("","novel-index-toggle-label","novel-index-toggle","目次"));const n=this.createDivEl("novel-index-menu","novel-menu"),l=this.createDivEl("","novel-index-contents");return l.appendChild(this.createPEl("","index-title",this.getTitle())),l.appendChild(this.createPEl("","index-subtitle",this.getSubtitle())),l.appendChild(this.createIndexList(e)),n.appendChild(l),t.appendChild(n),t}createIndexList(e){const t=window.location.href,i=document.createElement("ol");i.setAttribute("id","index-list"),this.addClass(i,"index-list");let n=-1;var l=document.createDocumentFragment();if(Object.keys(e).forEach((i,s)=>{const a=document.createElement("li");t.endsWith(e[i])?(a.appendChild(this.createAEl("","current",e[i],i)),n=s):a.appendChild(this.createAEl("","",e[i],i)),l.appendChild(a)}),i.appendChild(l),0<=n-1){const t=Object.keys(e)[n-1];this.insertHeader(t,e[t])}if(n+1<Object.keys(e).length){const t=Object.keys(e)[n+1];this.insertFooter(t,e[t])}else this.insertFooter(!1,!1);return i}insertHeader(e,t){const i=document.createElement("header");this.addClass(i,"novel-header"),i.appendChild(this.createAEl("","prev-link",t,e)),this.wrapper.insertBefore(i,this.wrapper.firstChild)}insertFooter(e,t){const i=document.createElement("footer");if(this.addClass(i,"novel-footer"),this.twitter){const e=this.createDivEl("","sns-wrap"),t=document.createElement("ul");this.addClass(t,"sns-list");const n=document.createElement("li"),l=window.location.href,s={text:this.getTitle()+" "+this.getSubtitle()+"\n「"+this.getSectionTitle()+"」",url:l};let a=[];for(let e in s)a[a.length]=encodeURIComponent(e)+"="+encodeURIComponent(s[e]);const d="https://twitter.com/intent/tweet?"+a.join("&");n.appendChild(this.createAEl("",["sns-link","btn-twitter"],d,"Twitter")),t.appendChild(n),e.appendChild(t),i.appendChild(e)}if(this.return){const n=document.createElement("a");e?(this.addClass(n,"next-link"),n.setAttribute("href",t),n.innerText=e):(this.addClass(n,"close-link"),n.setAttribute("href",this.return),n.innerText="閉じる"),i.appendChild(n)}this.wrapper.appendChild(i)}saveStyleLoad(){this.addClass(this.wrapper,"novel-wrapper");var e=this.getStrage("fontsize");this.fontsize=null!==e?e:"normal",this.addClass(this.wrapper,"fontsize-"+this.fontsize),document.getElementById("fontsize-"+this.fontsize).checked=!0;var t=this.getStrage("theme");this.theme=null!==t?t:"white",this.addClass(this.wrapper,"paper-"+this.theme),document.getElementById("theme-"+this.theme).checked=!0;var i=this.getStrage("font");this.font=null!==i?i:"mincho",this.addClass(this.wrapper,"font-"+this.font),document.getElementById("font-"+this.font).checked=!0;var n=this.getStrage("writing");this.writing=null!==n?n:"ltr",this.addClass(this.wrapper,this.writing),document.getElementById("write-"+this.writing).checked=!0}convertNovelText(){const e=document.getElementById("novel-body");let t=e.innerHTML;const i=(t=(t=(t=(t=(t=t.replace(/――/g,'<span class="dash-rule">―</span>―')).replace(/\|/g,"｜")).replace(/｜/g,"<ruby><rb>")).replace(/《/g,"</rb><rp>（</rp><rt>")).replace(/》/g,"</rt><rp>）</rp></ruby>")).split(/\r\n|\n/);let n=this.getImagesUri(i);this.loadingCount=0;let l=new Array(n.length);for(let e=0;e<n.length;e++)l[e]=new Image,l[e].src=n[e],l[e].classList.add("sashie"),l[e].alt="",l[e].addEventListener("load",()=>{const t=document.getElementById("sashie"+(e+1));l[e].width>l[e].height?l[e].classList.add("dir-v"):l[e].classList.add("dir-h");const i=document.createElement("p");i.appendChild(l[e]),t.parentNode.insertBefore(i,t),t.parentNode.removeChild(t),this.loadingCount++,this.loadingCount===n.length&&("rtl"===this.writing&&this.setScrollX(),this.loadingHide())});let s="",a=1;for(let e=0;e<i.length;e++){let t=i[e];t.includes("[")?(s+='<p id="sashie'+a+'"></p>',a++):this.indent&&this.firstCharCheck(t)?s+="<p>　"+(t=t.trim())+"</p>":s+="<p>"+t+"</p>"}return e.innerHTML=s,this.insertImageFlags(l),0<l.length}getTitle(){const e=document.getElementById("nvl-title");let t="";for(let i of e.childNodes)"#text"==i.nodeName&&(t+=i.nodeValue);return t.trim()}getSubtitle(){return document.getElementById("nvl-subtitle")?document.getElementById("nvl-subtitle").textContent.trim():""}getSectionTitle(){return document.getElementById("nvl-section-title").textContent.trim()}getImagesUri(e){let t=new Array;for(let i=0;i<e.length;i++){let n=e[i];n.includes("[")&&t.push(n.split("[")[1].split("]")[0])}return t}insertImageFlags(e){for(let t=0;t<e.length;t++){document.getElementById("sashie"+(t+1)).appendChild(e[t])}}loadingHide(){document.getElementById("loading").classList.add("hide")}toggleTheme(e){const t=e.target.value;this.changeClass(this.theme,t,"paper-"),this.theme=t,this.setStrage("theme",t)}toggleFont(e){const t=e.target.value;this.changeClass(this.font,t,"font-"),this.font=t,this.setStrage("font",t)}toggleFontsize(e){const t=document.body.scrollWidth-document.body.offsetWidth,i=window.scrollX,n=e.target.value;if(this.changeClass(this.fontsize,n,"fontsize-"),this.fontsize=n,this.setStrage("fontsize",n),"rtl"!==this.writing)return;const l=i-(t-(document.body.scrollWidth-document.body.offsetWidth));window.scroll(l,0)}toggleWriting(e){const t=e.target.value;this.changeClass(this.writing,t,""),this.writing=t,this.setStrage("writing",t),"ltr"===this.writing?this.setScrollY():this.setScrollX()}toggleStyle(e){let t=e.target.checked;document.getElementById("close-style").style.display=t?"block":"none"}toggleIndex(e){const t=e.target.checked;document.getElementById("close-index").style.display=t?"block":"none"}createMenuEl(e,t){const i=document.createElement("menu");return 0<e.length&&i.setAttribute("id",e),0<t.length&&this.addClass(i,t),i}createDivEl(e,t){const i=document.createElement("div");return 0<e.length&&i.setAttribute("id",e),0<t.length&&this.addClass(i,t),i}createPEl(e,t,i){const n=document.createElement("p");return 0<e.length&&n.setAttribute("id",e),0<t.length&&this.addClass(n,t),n.innerText=i,n}createSpanEl(e,t,i){const n=document.createElement("span");return 0<e.length&&n.setAttribute("id",e),0<t.length&&this.addClass(n,t),n.innerText=i,n}createAEl(e,t,i,n){const l=document.createElement("a");return 0<e.length&&l.setAttribute("id",e),0<t.length&&this.addClass(l,t),l.href=i,l.innerText=n,l}createLabelEl(e,t,i,n){const l=document.createElement("label");return 0<e.length&&l.setAttribute("id",e),0<t.length&&this.addClass(l,t),0<i.length&&l.setAttribute("for",i),l.innerText=n,l}craeteCheckboxEl(e,t){const i=document.createElement("input");return i.type="checkbox",0<e.length&&i.setAttribute("id",e),0<t.length&&this.addClass(i,t),i}createRadioEl(e,t,i,n){const l=document.createElement("input");return l.type="radio",0<e.length&&l.setAttribute("id",e),0<t.length&&this.addClass(l,t),0<i.length&&l.setAttribute("name",i),l.value=n,l}addClass(e,t){Array.isArray(t)?t.forEach(t=>{e.classList.add(t)}):e.classList.add(t)}changeClass(e,t,i){this.wrapper.classList.remove(i+e),this.wrapper.classList.add(i+t)}setScrollY(){window.scrollY;const e=document.body.scrollWidth-document.body.offsetWidth-window.scrollX;document.body.scrollHeight,document.body.scrollWidth,document.body.offsetWidth;this.touchDevice||window.removeEventListener("wheel",this.scrollyTox,{passive:!1}),window.scroll(0,e)}setScrollX(){const e=window.scrollY,t=(document.body.scrollWidth,document.body.offsetWidth,window.scrollX,document.body.scrollHeight,document.body.scrollWidth-document.body.offsetWidth);this.touchDevice||window.addEventListener("wheel",this.scrollyTox,{passive:!1}),window.scroll(t-e,0)}setStrage(e,t){localStorage.setItem(e,t)}getStrage(e){return localStorage.getItem(e)}scrollyTox(e){0===e.deltaX&&(e.stopPropagation(),e.preventDefault(),-1!==window.navigator.userAgent.toLowerCase().indexOf("firefox")?document.getElementById("app").scrollBy(10*-e.deltaY,0):document.getElementById("app").scrollBy(-e.deltaY,0))}firstCharCheck(e){const t=e.trim().substring(0,1);return"「"!==t&&("（"!==t&&("『"!==t&&"<i"!==e.substring(0,2)))}isTouchDevice(){var e=!1;return null===window.ontouchstart&&(e=!0),e}fontCheck(){return navigator.userAgent.includes("Android")}}